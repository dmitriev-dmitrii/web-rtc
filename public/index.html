<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title> Web-RTC  </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.2.0/adapter.js"></script>
</head>
<body>
    <h1 style="text-align: center">Web-RTC</h1>
    <h2>wsOnlineClients : <span id="wsOnlineClientsDom"></span></h2>

    <button id="connectButton"> connectButton </button>

    <fieldset id="webRtcChat">

        <legend>Web-RTC chat</legend>

        <li id="webRtcChatMessages"></li>

        <form id="webRtcChatForm">
            <input type="text" id="webRtcChatInput" placeholder="Введите сообщение" required />
            <button type="submit">Отправить</button>
        </form>

    </fieldset>

</div>


    </div>

    
    <script type="module" defer>
        const userId = adapter.browserDetails.browser

        import {setupOnWsMessageHandlers, sendWsMessage} from "./ws.js";

        import { useWebRtc} from "./web-rtc.js";

        
        const wsOnlineClientsDom = document.getElementById('wsOnlineClientsDom');
        const connectButton = document.getElementById('connectButton');


        const webRtcChatForm = document.getElementById('webRtcChatForm');
        const webRtcChatInput = document.getElementById('webRtcChatInput');
        const webRtcChatMessages = document.getElementById('webRtcChatMessages');

        let wsOnlineClients = []

        const printChatMessage = ( message )=> {
            const listItem = document.createElement('li')
            listItem.innerText = message
            webRtcChatMessages.append(listItem)
        }

       const  onDataChanelMessage = ( { data , from } )=> {

           const message = `[${from}] : ${data.text}`
           printChatMessage(message)

       }

      const onDataChanelOpen = (payload)=> {
          printChatMessage(payload.currentTarget.label + ' data chanel is open' )
      }
      const onDataChanelClose = (payload)=> {
          printChatMessage(payload.currentTarget.label + ' data chanel is closed' )
      }

        const {
            createPeerOffer ,
            confirmPeerOffer ,
            setupPeerAnswer  ,
            updatePeerIceCandidate,
            sendDataChanelMessage,
        } = useWebRtc({
            onDataChanelOpen,
            onDataChanelClose,
            onDataChanelMessage
        })

        const updateWsOnlineClients = ({data})=> {
            wsOnlineClients = data.wsClientsOnline
            wsOnlineClientsDom.innerText = JSON.stringify(data.wsClientsOnline)
        }

        connectButton.onclick = async () => {

            const payload = {
                type: 'join-request'
            }

            sendWsMessage(payload)
        }


        const printJoinRequest = (e)=>{
            console.log(e)
            printChatMessage(e.from + ' start web rtc connecting...' )
        }

        setupOnWsMessageHandlers({
            'join-request' : [createPeerOffer , printJoinRequest ],
            'offer': confirmPeerOffer,
            'answer': setupPeerAnswer,
            'ice-candidate': updatePeerIceCandidate,

            'ws-connection': updateWsOnlineClients,
            'ws-close': updateWsOnlineClients,
        })


        webRtcChatForm.addEventListener('submit', (event) => {

            event.preventDefault();

            if (!webRtcChatInput.value) {
                return
            }

            const payload  = {
                type : 'text-message',
                data :{
                    text: webRtcChatInput.value,
                }
            }


            sendDataChanelMessage(payload)

            printChatMessage(`[me] : ${webRtcChatInput.value}`)

            webRtcChatInput.value = '';
        });

    </script>

        <style>
            *{
                box-sizing: border-box;
            }

            #webRtcChat {
                display: flex;
                align-items: stretch;
                height: 300px;
            }

            #webRtcChatForm {
                display: flex;
                flex-direction: column;
                justify-content: flex-end;
                align-items: stretch;

                width: 100%;
                margin: 0;
                padding: 0;
            }

            #webRtcChatMessages {
                margin: 0;
                padding: 0;
                display: block;
                width: 100%;
                overflow: auto;
            }


            #webRtcChatMessages:empty:before {
                content: 'chat is empty';
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: slategray;
            }

            #webRtcChatMessages:empty:before {
                content: 'chat is empty';
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: slategray;
            }

            #webRtcChatMessages:before{
                content: 'chat messages';
            }

            #webRtcChatMessages:empty:before {
                content: 'chat is empty';
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: slategray;
            }


            input[type="text"] {
                height: 1.75rem;
                padding: .25rem 1rem;
                border-radius: 5px;
                border: 1px solid currentColor;
            }

            button {
                height: 1.75rem;
                padding: .25rem 1rem;
                border-radius: 5px;
                border: 1px solid currentColor;
                cursor: pointer;
            }

            fieldset {
                border: 1px solid currentColor;
                border-radius: 5px;
            }
            legend {
                font-weight: bold;
                font-size: 1.5rem;
            }

        </style>
</body>
</html>
