<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title> Web-RTC  </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.2.0/adapter.js"></script>
</head>
<body>
    <h1 style="text-align: center">Web-RTC</h1>
    <h2>wsOnlineClients : <span id="wsOnlineClientsDom"></span></h2>

    <button id="connectButton"> connectButton </button>

    <fieldset id="webRtcChat">

        <legend>Web-RTC chat</legend>

        <li id="webRtcChatMessages"></li>

        <form id="webRtcChatForm">
            <input type="text" id="webRtcChatInput" placeholder="Введите сообщение" required />
            <button type="submit">Отправить</button>
        </form>

    </fieldset>

</div>


    </div>

    
    <script type="module" defer>
        import {WEB_SOCKET_EVENTS,DATA_CHANNELS_EVENTS} from "./constants.js";

        const userId = adapter.browserDetails.browser

        import {setupOnWsMessageHandlers, sendWsMessage} from "./ws.js";

        import { useWebRtcConnections } from "./web-rtc/useWebRtcConnections.js";
        import { useWebRtcDataChannels } from "./web-rtc/useWebRtcDataChannels.js";



        const wsOnlineClientsDom = document.getElementById('wsOnlineClientsDom');
        const connectButton = document.getElementById('connectButton');


        const webRtcChatForm = document.getElementById('webRtcChatForm');
        const webRtcChatInput = document.getElementById('webRtcChatInput');
        const webRtcChatMessages = document.getElementById('webRtcChatMessages');

        const {
            sendMeOffer,
            createPeerOffer ,
            confirmPeerOffer ,
            setupPeerAnswer  ,
            updatePeerIceCandidate,
        } = useWebRtcConnections()


        const { sendDataChanelMessage , setupCallbacks }  =   useWebRtcDataChannels()

        const printChatMessage = ( message )=> {
            const listItem = document.createElement('li')
            listItem.innerText = message
            webRtcChatMessages.append(listItem)
        }

        const  onDataChanelMessage = ( { data , type , from } )=> {

            if (type === 'text') {
                const message = `[${from}] : ${data.text}`
                printChatMessage(message)
            }

        }
        const onDataChanelOpen = (e)=>{
            console.log(e)

            printChatMessage( e.label + ' channel is open')
        }

        const onDataChanelClose = (e)=>{
            console.log(e)
            printChatMessage(e.label + ' channel is closed')
        }


        const updateWsOnlineClients = ({data})=> {

            wsOnlineClientsDom.innerText = JSON.stringify(data.wsClientsOnline)
        }

        setupOnWsMessageHandlers({
            [WEB_SOCKET_EVENTS.RTC_SEND_ME_OFFER]: [createPeerOffer],
            [WEB_SOCKET_EVENTS.RTC_OFFER]: confirmPeerOffer,
            [WEB_SOCKET_EVENTS.RTC_ANSWER]: setupPeerAnswer,
            [WEB_SOCKET_EVENTS.RTC_ICE_CANDIDATE]: updatePeerIceCandidate,

            [WEB_SOCKET_EVENTS.WS_CONNECTION]: updateWsOnlineClients,
            [WEB_SOCKET_EVENTS.WS_CLOSE]: updateWsOnlineClients,
        })


,
        setupCallbacks({
            [DATA_CHANNELS_EVENTS.DATA_CHANEL_ON_OPEN]:onDataChanelOpen,
            [DATA_CHANNELS_EVENTS.DATA_CHANEL_ON_CLOSE]:  onDataChanelClose,
            [DATA_CHANNELS_EVENTS.DATA_CHANEL_ON_MESSAGE]: onDataChanelMessage,
        })


        connectButton.onclick = sendMeOffer

        webRtcChatForm.addEventListener('submit', (event) => {

            event.preventDefault();

            if (!webRtcChatInput.value) {
                return
            }

            const payload  = {
                type : 'text-message',
                data :{
                    text: webRtcChatInput.value,
                }
            }

            sendDataChanelMessage(payload)

            printChatMessage(`[me] : ${webRtcChatInput.value}`)

            webRtcChatInput.value = '';
        });



    </script>

        <style>
            *{
                box-sizing: border-box;
            }

            #webRtcChat {
                display: flex;
                align-items: stretch;
                height: 300px;
            }

            #webRtcChatForm {
                display: flex;
                flex-direction: column;
                justify-content: flex-end;
                align-items: stretch;

                width: 100%;
                margin: 0;
                padding: 0;
            }

            #webRtcChatMessages {
                margin: 0;
                padding: 0;
                display: block;
                width: 100%;
                overflow: auto;
            }


            #webRtcChatMessages:empty:before {
                content: 'chat is empty';
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: slategray;
            }

            #webRtcChatMessages:empty:before {
                content: 'chat is empty';
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: slategray;
            }

            #webRtcChatMessages:before{
                content: 'chat messages';
            }

            #webRtcChatMessages:empty:before {
                content: 'chat is empty';
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: slategray;
            }


            input[type="text"] {
                height: 1.75rem;
                padding: .25rem 1rem;
                border-radius: 5px;
                border: 1px solid currentColor;
            }

            button {
                height: 1.75rem;
                padding: .25rem 1rem;
                border-radius: 5px;
                border: 1px solid currentColor;
                cursor: pointer;
            }

            fieldset {
                border: 1px solid currentColor;
                border-radius: 5px;
            }
            legend {
                font-weight: bold;
                font-size: 1.5rem;
            }

        </style>
</body>
</html>
