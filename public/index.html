<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title> Web-RTC  </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.2.0/adapter.js"></script>
</head>
<body>
    <h1 style="text-align: center">Web-RTC</h1>
    <h2>wsOnlineCount : <span id="wsOnlineCount"></span></h2>
    <ol id="statusList"></ol>

    <button id="createOfferButton"> createOffer </button>
    <button id="fetchOffersButton"> fetchOffers </button>

    <button id="connectButton"> connectButton </button>

    <div id="offersList">

    </div>

    <fieldset id="webRtcChat">

        <legend>Web-RTC chat</legend>

        <li id="webRtcChatMessages"></li>

        <form id="webRtcChatForm">
            <ul id="webRtcChatOnlineUsers"></ul>
            <input type="text" id="webRtcChatInput" placeholder="Введите сообщение" required />
            <button type="submit">Отправить</button>
        </form>

    </fieldset>



</div>


    </div>

    
    <script type="module" defer>
        const userId = adapter.browserDetails.browser

        import {setupOnWsMessageHandlers, sendWsMessage} from "./ws.js";

        import { useWebRtc} from "./web-rtc.js";

        const statusList = document.getElementById('statusList');
        
        const wsOnlineCount = document.getElementById('wsOnlineCount');
        const createOfferButton = document.getElementById('createOfferButton');
        const fetchOffersButton = document.getElementById('fetchOffersButton');
        const offersList = document.getElementById('offersList');
        const connectButton = document.getElementById('connectButton');


        const webRtcChatForm = document.getElementById('webRtcChatForm');
        const webRtcChatInput = document.getElementById('webRtcChatInput');
        const webRtcChatMessages = document.getElementById('webRtcChatMessages');


        const printChatMessage = ( message )=> {
            const listItem = document.createElement('li')
            listItem.innerText = message
            webRtcChatMessages.append(listItem)
        }

       const  onDataChanelMessage = ( { data , from } )=> {

           const message = `[${from}] : ${data.text}`
           printChatMessage(message)

       }

      const onDataChanelOpen = (payload)=> {
          printChatMessage(payload.currentTarget.label + ' chanel is open' )
      }
      const onDataChanelClose = (payload)=> {
          printChatMessage(payload.currentTarget.label + ' chanel is closed' )
      }

        const {
            createPeerOffer ,
            confirmPeerOffer ,
            setupPeerAnswer  ,
            sendDataChanelMessage,
        } = useWebRtc({
            onDataChanelOpen,
            onDataChanelClose,
            onDataChanelMessage
        })

        createOfferButton.onclick = createPeerOffer

        let offers = {}
        const fetchOffers =  async  () => {
            const res = await fetch('/offers')
            offers = await res.json()
        }


        fetchOffersButton.onclick = async ()=> { 
           await fetchOffers()
           offersList.innerHTML = ''

           for ( const key of Object.keys(offers)) {
                if (key !== userId ) {
                    const offerButton =  document.createElement('button')
                    offerButton.setAttribute('id', key)
                    offerButton.innerText = `connect to [${key}] `
                    offersList.append(offerButton)
                }
           }
        }
        
        
        offersList.addEventListener('click', async  (e)=> {

            const currentOffer = offers[e.target.id]
            
            if (!currentOffer) {
                return
            }

            e.target.disabled = true

           await  confirmPeerOffer({ to: e.target.id ,data:currentOffer })
        })


        const updateWsOnlineCount = ({data})=> {
            console.log(data)
            wsOnlineCount.innerText = data.wsClientsOnline
        }

        connectButton.onclick = async () => {

            await  createPeerOffer()
            await fetchOffers()

            for ( const [ key , value ] of Object.entries(offers)) {

                if (key !== userId ) {
                    await confirmPeerOffer({ to: key ,data:value })
                }

            }

        }



        setupOnWsMessageHandlers({

            'answer': setupPeerAnswer,
            // 'ice-candidate': onIceCandidate,
            'ws-connection': updateWsOnlineCount,
            'ws-close': updateWsOnlineCount,
        })


        webRtcChatForm.addEventListener('submit', (event) => {

            event.preventDefault();

            if (!webRtcChatInput.value) {
                return
            }

            const payload  = {
                type : 'text-message',
                data :{
                    text: webRtcChatInput.value,
                }
            }


            sendDataChanelMessage(payload)

            printChatMessage(`[me] : ${webRtcChatInput.value}`)

            webRtcChatInput.value = '';
        });

    </script>

        <style>
            *{
                box-sizing: border-box;
            }

            .videoStreamsElement {
                display: flex;
                align-self: center;
                gap: 2rem;
            }

            video {
                border-radius:10px;
                max-width: 400px;
                max-height: 300px;
            }

            #localVideo {
                border:2px solid royalblue;
            }

            #webRtcChat {
                display: flex;
                align-items: stretch;
                height: 300px;
            }

            #webRtcChatForm {
                display: flex;
                flex-direction: column;
                justify-content: flex-end;
                align-items: stretch;

                width: 100%;
                margin: 0;
                padding: 0;
            }

            #webRtcChatOnlineUsers {
                margin: 0;
                padding: 0;
                flex: 1;
                width: 100%;
                list-style:none;
                display: flex;
                flex-wrap: wrap-reverse;
            }

            #webRtcChatOnlineUsers:before {
                color: slategray;
                content: 'connected users :';
                font-weight: bold;
            }

            #webRtcChatOnlineUsers:empty {
                opacity: 0;
            }


            #webRtcChatMessages {
                margin: 0;
                padding: 0;
                display: block;
                width: 100%;
                overflow: auto;
            }


            #webRtcChatMessages:empty:before {
                content: 'chat is empty';
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: slategray;
            }

            #webRtcChatMessages:empty:before {
                content: 'chat is empty';
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: slategray;
            }

            #webRtcChatMessages:before{
                content: 'chat messages';
            }

            #webRtcChatMessages:empty:before {
                content: 'chat is empty';
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: slategray;
            }


            input[type="text"] {
                height: 1.75rem;
                padding: .25rem 1rem;
                border-radius: 5px;
                border: 1px solid currentColor;
            }

            button {
                height: 1.75rem;
                padding: .25rem 1rem;
                border-radius: 5px;
                border: 1px solid currentColor;
                cursor: pointer;
            }

            fieldset {
                border: 1px solid currentColor;
                border-radius: 5px;
            }
            legend {
                font-weight: bold;
                font-size: 1.5rem;
            }

        </style>
</body>
</html>
