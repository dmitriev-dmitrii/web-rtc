<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title> Web-RTC  </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.2.0/adapter.js"></script>
</head>
<body>
    <h1>Web-RTC</h1>
    <ol id="statusList"></ol>

    <button id="startCall"> startCall </button>

        <form id="webRtcChatForm">
            <h2>Web-RTC chat</h2>
            <ul id="webRtcChatMessageList"></ul>
            <input type="text" id="webRtcChatInput" placeholder="Введите сообщение" required />
            <button type="submit">Отправить</button>
        </form>

    </div>

    <script type="module" defer>
        const userId = adapter.browserDetails.browser

        const socket = new WebSocket(`ws://${window.location.host}/?hui=${ userId }&userId=${ userId }`);

        const statusList = document.getElementById('statusList');

        const startCallButton = document.getElementById('startCall');

        const webRtcChatForm = document.getElementById('webRtcChatForm');
        const webRtcChatInput = document.getElementById('webRtcChatInput');
        const webRtcChatMessageList = document.getElementById('webRtcChatMessageList');

        const peerConnections = {}; // Хранение всех соединений
        const channels = {}; // Хранение всех каналов данных


        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        peerConnections[userId] = new RTCPeerConnection(configuration);
        channels[userId] = peerConnections[userId].createDataChannel(`${userId}`);


        const printPeerConnectionState = (event)=> {
            const li = document.createElement('li')
            li.innerText = event.currentTarget.connectionState
            statusList.append(li)
        }

        function printChatMessage(message) {
            const messageElement = document.createElement('li');
            messageElement.textContent = message;
            webRtcChatMessageList.appendChild(messageElement);
        }


        webRtcChatForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const message = `${userId}: ${webRtcChatInput.value}`;
            channels[userId].send(message); // Отправка сообщения через DataChannel
            printChatMessage(message); // Отображение отправленного сообщения
            webRtcChatInput.value = ''; // Очистка поля ввода
        });

        peerConnections[userId].ondatachannel = (event) => {

            event.channel.onmessage = (event) => {
                printChatMessage(event.data);
            };

            printChatMessage(event.channel.label + ' connected')
        };

        peerConnections[userId].onicecandidate = (event) => {
            if (event.candidate) {
                socket.send(JSON.stringify({ type: 'ice-candidate', candidate: event.candidate }));
            }
        };

        peerConnections[userId].onconnectionstatechange = (e)=> {
            printPeerConnectionState(e)
        }

        async function createPeerOffer() {

            const offer = await peerConnections[userId].createOffer();
            await peerConnections[userId].setLocalDescription(offer)
            return offer
            // socket.send(JSON.stringify({ type: 'offer', offer }));
        }


        const onIceCandidate = async (message)=> {
            await peerConnections[userId].addIceCandidate(new RTCIceCandidate(message.candidate));
        }

        const  onPeerOffer = async (message)=> {
            await peerConnections[userId].setRemoteDescription(new RTCSessionDescription(message.offer));
        }
        const createPeerAnswer = async ()=> {
            const answer = await peerConnections[userId].createAnswer();
            await peerConnections[userId].setLocalDescription(answer);
            socket.send(JSON.stringify({ type: 'answer', answer }));
        }
        const onPeerAnswer = async (message)=> {
            await peerConnections[userId].setRemoteDescription(new RTCSessionDescription(message.answer));
        }

        const onNewUser = (message) => {

            const {newUserId} = message;
            console.log('socket on new user', message)
            peerConnections[newUserId] = new RTCPeerConnection(configuration);

            // Обработка ICE кандидатов
            peerConnections[newUserId].onicecandidate = (event) => {
                if (event.candidate) {
                    socket.send(JSON.stringify({ type: 'ice-candidate', candidate: event.candidate, newUserId }));
                }
            };

        };

        socket.onmessage = async (event) => {
            try {
                const message = JSON.parse(event.data);

                // if (message.type === 'offer') {
                //     await  onPeerOffer(message)
                //     await  createPeerAnswer()
                //     return
                // }

                if (message.type === 'answer') {
                   await onPeerAnswer(message)
                   return
                }

                if (message.type === 'ice-candidate') {
                   await onIceCandidate(message)
                   return;
                }

                if (message.type === 'new-user') {
                    onNewUser(message);
                }
            } catch (error) {
                console.error('Ошибка при обработке ws сообщения:', error);
            }
        };

        startCallButton.addEventListener('click', async ()=> {


            const res = await  fetch('/offers')
            const data = await res.json()

            for (const [key, value] of Object.entries(data)) {
                if (key !== userId ) {
                  await  onPeerOffer(value)
                  await  createPeerAnswer()
                }
            }

            const offer = await createPeerOffer()

            await fetch('/offers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json;charset=utf-8'
                },
                body: JSON.stringify({ type: 'offer', offer , userId })
            });

        });



    </script>

        <style>
            *{
                box-sizing: border-box;
            }

            .videoStreamsElement {
                display: flex;
                align-self: center;
                gap: 2rem;
            }
            video {
                border-radius:10px;
                max-width: 400px;
                max-height: 300px;
            }

            #localVideo {
                border:2px solid royalblue;
            }

            #messageContainer {
                margin-top: 20px;
            }
            #webRtcChatInput {
                height: 1.75rem;
                padding: .25rem 1rem;
                border-radius: 5px;
                border: 1px solid currentColor;
            }

            button {
                height: 1.75rem;
                padding: .25rem 1rem;
                border-radius: 5px;
                border: 1px solid currentColor;
                cursor: pointer;
            }

        </style>
</body>
</html>
